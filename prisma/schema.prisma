// =======================
// GENERATOR & DATASOURCE
// =======================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============
// ENUMS
// ============

enum Role {
  CLIENT
  BARBER
  ADMIN
}

enum AppointmentStatus {
  PENDING
  DONE
  CANCELED
}

enum BarberDailyAvailabilityType {
  DAY_OFF
  CUSTOM
}

enum ExpenseCategory {
  RENT
  UTILITIES
  TAXES
  SUPPLIES
  OTHER
}

enum ClientPlanStatus {
  ACTIVE
  EXPIRED
  CANCELED
}

// ============
// MODELS
// ============

model User {
  id String @id @default(cuid())

  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  phone         String?
  passwordHash  String?

  // üéÇ Data de anivers√°rio do cliente (opcional)
  birthday DateTime?

  role Role @default(CLIENT)

  appointmentsAsClient Appointment[] @relation("ClientAppointments")

  clientPlans ClientPlan[]

  barber Barber?

  accounts Account[]
  sessions Session[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =======================
// NEXTAUTH
// =======================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// =======================
// DOM√çNIO
// =======================

model Barber {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  phone     String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userId String? @unique
  user   User?   @relation(fields: [userId], references: [id])

  appointments Appointment[]

  weeklyAvailabilities BarberWeeklyAvailability[]
  dailyAvailabilities  BarberDailyAvailability[]

  // ‚≠ê VENDAS DE PRODUTO
  productSales ProductSale[]

  @@map("barbers")
}

// =======================
// SERVICES / APPOINTMENTS
// =======================

model Service {
  id                  String   @id @default(cuid())
  name                String
  price               Decimal  @db.Decimal(10, 2)
  durationMinutes     Int
  isActive            Boolean  @default(true)
  barberPercentage    Decimal  @default(50.0) @db.Decimal(5, 2)
  cancelLimitHours    Int?
  cancelFeePercentage Decimal? @db.Decimal(5, 2)

  appointments Appointment[]
  planServices PlanService[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("services")
}

// =======================
// PLANOS
// =======================

model Plan {
  id   String @id @default(cuid())
  name String

  description       String?
  price             Decimal @db.Decimal(10, 2)
  durationDays      Int     @default(30)
  totalBookings     Int     @default(4)
  commissionPercent Int
  isActive          Boolean @default(true)

  services    PlanService[]
  clientPlans ClientPlan[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("plans")
}

model PlanService {
  id String @id @default(cuid())

  planId    String
  serviceId String

  plan    Plan    @relation(fields: [planId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([planId, serviceId])
  @@map("plan_services")
}

model ClientPlan {
  id       String @id @default(cuid())
  clientId String
  planId   String

  startDate    DateTime
  endDate      DateTime
  usedBookings Int              @default(0)
  status       ClientPlanStatus @default(ACTIVE)

  client User @relation(fields: [clientId], references: [id])
  plan   Plan @relation(fields: [planId], references: [id])

  appointments Appointment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([planId])
  @@map("client_plans")
}

model Appointment {
  id          String   @id @default(cuid())
  description String
  clientName  String
  phone       String
  scheduleAt  DateTime

  status AppointmentStatus @default(PENDING)

  clientId String
  client   User   @relation("ClientAppointments", fields: [clientId], references: [id])

  barberId String?
  barber   Barber? @relation(fields: [barberId], references: [id])

  serviceId String?
  service   Service? @relation(fields: [serviceId], references: [id])

  servicePriceAtTheTime     Decimal? @db.Decimal(10, 2)
  barberPercentageAtTheTime Decimal? @db.Decimal(5, 2)
  barberEarningValue        Decimal? @db.Decimal(10, 2)

  cancelFeeApplied Boolean  @default(false)
  cancelFeeValue   Decimal? @db.Decimal(10, 2)
  cancelledByRole  Role?
  concludedByRole  Role?

  clientPlanId String?
  clientPlan   ClientPlan? @relation(fields: [clientPlanId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
  @@index([barberId])
  @@index([scheduleAt])
  @@index([serviceId])
  @@index([clientPlanId])
  @@map("appointments")
}

// =======================
// ‚≠ê PRODUCTS + STOCK
// =======================

model Product {
  id               String  @id @default(cuid())
  name             String
  imageUrl         String
  description      String
  price            Decimal @db.Decimal(10, 2)
  barberPercentage Int
  category         String
  isActive         Boolean @default(true)

  // ‚≠ê ESTOQUE
  stockQuantity Int @default(0)

  // ‚≠ê RELA√á√ÉO COM VENDAS
  sales ProductSale[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// =======================
// ‚≠ê REGISTRO DE VENDA DE PRODUTO
// =======================

model ProductSale {
  id String @id @default(cuid())

  productId String
  product   Product @relation(fields: [productId], references: [id])

  barberId String
  barber   Barber @relation(fields: [barberId], references: [id])

  quantity   Int
  unitPrice  Decimal @db.Decimal(10, 2)
  totalPrice Decimal @db.Decimal(10, 2)

  soldAt    DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([barberId])
  @@index([soldAt])
}

// =======================
// EXPENSES
// =======================

model Expense {
  id          String          @id @default(cuid())
  description String
  category    ExpenseCategory
  amount      Decimal         @db.Decimal(10, 2)
  dueDate     DateTime
  isRecurring Boolean         @default(false)
  isPaid      Boolean         @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([dueDate])
  @@map("expenses")
}

// =======================
// DISPONIBILIDADE
// =======================

model BarberWeeklyAvailability {
  id        String                     @id @default(cuid())
  barberId  String
  barber    Barber                     @relation(fields: [barberId], references: [id], onDelete: Cascade)
  weekday   Int
  isActive  Boolean                    @default(true)
  intervals BarberWeeklyTimeInterval[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([barberId, weekday])
  @@map("barber_weekly_availabilities")
}

model BarberWeeklyTimeInterval {
  id                   String                   @id @default(cuid())
  weeklyAvailabilityId String
  weeklyAvailability   BarberWeeklyAvailability @relation(fields: [weeklyAvailabilityId], references: [id], onDelete: Cascade)
  startTime            String
  endTime              String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("barber_weekly_time_intervals")
}

model BarberDailyAvailability {
  id        String                      @id @default(cuid())
  barberId  String
  barber    Barber                      @relation(fields: [barberId], references: [id], onDelete: Cascade)
  date      DateTime
  type      BarberDailyAvailabilityType
  intervals BarberDailyTimeInterval[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([barberId, date])
  @@map("barber_daily_availabilities")
}

model BarberDailyTimeInterval {
  id                  String                  @id @default(cuid())
  dailyAvailabilityId String
  dailyAvailability   BarberDailyAvailability @relation(fields: [dailyAvailabilityId], references: [id], onDelete: Cascade)
  startTime           String
  endTime             String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("barber_daily_time_intervals")
}
